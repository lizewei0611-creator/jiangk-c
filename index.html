<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>赛事门户 | 首页</title>
    <meta name="description" content="查看赛事、个人成绩与账户信息的门户首页" />
    <!-- 如有全局样式，可保留；没有就删掉这一行 -->
    <!-- <link rel="stylesheet" href="/assets/styles.css" /> -->
    <link rel="stylesheet" href="/assets/c-portal.css" />
  </head>
  <body>
    <header class="container header">
      <div class="brand">
        <img
          src="https://picsum.photos/seed/brand/36/36"
          alt="logo"
          style="border-radius: 8px; border: 1px solid #e6e8eb"
        />
        <span>赛事门户</span>
      </div>
      <nav class="nav" id="main-nav">
        <a href="/" data-path="/" aria-label="首页">首页</a>
        <a href="/events/" data-path="/events/" aria-label="赛事">赛事</a>
        <a
          href="/me/achievements.html"
          data-path="/me/achievements.html"
          aria-label="我的成绩"
          >我的成绩</a
        >
        <a href="/organizer/" data-path="/organizer/" aria-label="主办方"
          >主办方</a
        >
        <a href="/help/" data-path="/help/" aria-label="帮助中心">帮助中心</a>
      </nav>
    </header>

    <main class="container">
      <div class="notice">
        <span>公告</span>
        <span class="muted"
          >报名高峰期，建议提前完成实名认证与体检证明上传。</span
        >
        <button
          class="btn link"
          onclick="location.href='/help/article.html?id=notice_signup'"
        >
          查看详情
        </button>
      </div>

      <section class="hero">
        <div class="split">
          <div class="grow">
            <h1>欢迎来到赛事门户</h1>
            <p class="muted">
              查看近期赛事、个人成绩与账户信息。支持龙舟、赛艇等项目。
            </p>
            <div class="pill-links" style="margin-top: 10px">
              <a href="/events/">查看全部赛事</a>
              <a href="/me/achievements.html">查看我的成绩</a>
              <a href="/organizer/create-event.html">发布赛事</a>
            </div>
          </div>
          <div>
            <button class="btn primary" onclick="location.href='/events/'">
              立即报名
            </button>
          </div>
        </div>
      </section>

      <section class="grid">
        <div class="col-8">
          <div class="card">
            <div class="split" style="margin-bottom: 8px">
              <h2 class="grow">近期赛事</h2>
              <div class="section-actions">
                <button class="btn" onclick="location.href='/events/'">
                  全部赛事
                </button>
              </div>
            </div>
            <div id="events-list" class="list">
              <div class="empty">正在加载赛事数据...</div>
            </div>
          </div>

          <div class="card" style="margin-top: 16px">
            <div class="split" style="margin-bottom: 8px">
              <h2 class="grow">我的近期成绩</h2>
              <div class="section-actions">
                <button
                  class="btn"
                  onclick="location.href='/me/achievements.html'"
                >
                  查看全部
                </button>
              </div>
            </div>
            <div id="achievements-list" class="list">
              <div class="empty">正在加载我的成绩...</div>
            </div>
          </div>
        </div>

        <aside class="col-4">
          <div class="card">
            <h2>我的信息</h2>
            <div class="split" style="margin-top: 8px">
              <div class="item-meta">
                <img
                  id="profile-avatar"
                  class="avatar"
                  src="https://picsum.photos/seed/user/80/80"
                  alt="头像"
                />
                <div>
                  <div id="profile-nickname"><strong>未登录</strong></div>
                  <div class="muted" id="profile-uid">—</div>
                </div>
              </div>
              <button class="btn" id="login-btn">登录</button>
            </div>
            <div class="stat" style="margin-top: 12px">
              <div>完赛数 <strong id="stat-finished">—</strong></div>
              <div>PB 次数 <strong id="stat-pb">—</strong></div>
            </div>
          </div>

          <div class="card" style="margin-top: 16px">
            <h2>常用入口</h2>
            <div class="pill-links" style="margin-top: 6px">
              <a href="/events/">赛事列表</a>
              <a href="/organizer/">主办方</a>
              <a href="/organizer/create-event.html">发布赛事</a>
              <a href="/help/">帮助中心</a>
              <a href="/me/achievements.html">我的成绩</a>
            </div>
          </div>
        </aside>
      </section>
    </main>

    <footer class="container footer">
      <div>© 2025 赛事门户 · 联系方式 · 备案信息</div>
    </footer>

    <script>
      // 导航高亮（需通过 http(s) 访问页面，而不是 file://）
      (function highlightNav() {
        var path = location.pathname || "/";
        var nav = document.getElementById("main-nav");
        if (!nav) return;
        var links = nav.querySelectorAll("a[data-path]");
        links.forEach(function (a) {
          var p = a.getAttribute("data-path");
          if (p === "/" && (path === "/" || path.endsWith("/index.html")))
            a.classList.add("active");
          else if (p !== "/" && path.indexOf(p) === 0)
            a.classList.add("active");
        });
      })();

      document
        .getElementById("login-btn")
        .addEventListener("click", function () {
          alert("这里对接登录：可跳 /me/login.html 或打开登录弹窗");
        });

      async function safeFetch(url) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 4000); // 4秒超时
        try {
          const res = await fetch(url, {
            credentials: "same-origin",
            signal: controller.signal,
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          return await res.json();
        } catch (e) {
          console.warn("加载失败", url, e);
          return null;
        } finally {
          clearTimeout(timeout);
        }
      }

      function formatDateRange(start, end) {
        if (!start && !end) return "";
        if (start && end && start !== end) return start + " ~ " + end;
        return start || end || "";
      }
      function msToTime(ms) {
        if (typeof ms !== "number") return "—";
        const m = Math.floor(ms / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        const cs = Math.floor((ms % 1000) / 10);
        return (
          m +
          ":" +
          String(s).padStart(2, "0") +
          "." +
          String(cs).padStart(2, "0")
        );
      }

      // 兼容你上传的 events.json 与 achievements_me.json 字段
      async function renderEvents() {
        const box = document.getElementById("events-list");
        // 与本文件同目录：index.html、events.json、achievements_me.json 放一起
        const data = await safeFetch("./events.json");
        if (!data || !Array.isArray(data.events) || data.events.length === 0) {
          box.innerHTML = '<div class="empty">暂无可展示的赛事</div>';
          return;
        }
        const list = data.events
          .slice(0, 5)
          .map(function (ev) {
            const statusMap = {
              signup: "报名中",
              soon: "即将开始",
              ongoing: "进行中",
              finished: "已结束",
            };
            const status = statusMap[ev.status] || ev.status || "进行中";
            const date =
              formatDateRange(ev.start_date, ev.end_date) || ev.date || "";
            const city = ev.city || "";
            const name = ev.name || ev.event_name || "未命名赛事";
            const id = ev.id || ev.event_id || "";
            const href = id
              ? "/events/detail.html?id=" + encodeURIComponent(id)
              : "/events/";
            return (
              '<div class="list-item clickable" onclick="location.href=\'' +
              href +
              "'\">" +
              '<div class="item-meta">' +
              '<span class="badge">' +
              status +
              "</span>" +
              "<div>" +
              "<div><strong>" +
              name +
              "</strong></div>" +
              '<div class="muted">' +
              date +
              (city ? " · " + city : "") +
              "</div>" +
              "</div>" +
              "</div>" +
              '<button class="btn" onclick="event.stopPropagation();location.href=\'' +
              href +
              "'\">详情</button>" +
              "</div>"
            );
          })
          .join("");
        box.innerHTML = list;
      }

      async function renderAchievements() {
        const box = document.getElementById("achievements-list");
        const data = await safeFetch("./achievements_me.json");
        if (
          !data ||
          !Array.isArray(data.achievements) ||
          data.achievements.length === 0
        ) {
          box.innerHTML = '<div class="empty">暂无成绩或未登录</div>';
          return;
        }
        const list = data.achievements
          .slice(0, 3)
          .map(function (a) {
            const name = a.event_name || a.name || "赛事";
            const rank = (a.rank || a.position) ?? "—";
            const time = a.time_ms ? msToTime(a.time_ms) : a.time || "—";
            const cover = a.cover || "https://picsum.photos/seed/cert/80/80";
            const cat = a.category || a.distance || "";
            const date = a.date || "";
            return (
              '<div class="list-item clickable" onclick="location.href=\'/me/achievements.html\'">' +
              '<div class="item-meta">' +
              '<img class="avatar" src="' +
              cover +
              '" alt="cover" />' +
              "<div>" +
              "<div><strong>" +
              name +
              "</strong></div>" +
              '<div class="muted">' +
              [date, cat, "名次 " + rank, "成绩 " + time]
                .filter(Boolean)
                .join(" · ") +
              "</div>" +
              "</div>" +
              "</div>" +
              '<button class="btn link" onclick="event.stopPropagation();location.href=\'/me/achievements.html\'">详情</button>' +
              "</div>"
            );
          })
          .join("");
        box.innerHTML = list;
      }

      async function renderProfile() {
        const data = await safeFetch("./achievements_me.json");
        if (!data || !data.profile) return;
        const p = data.profile;
        var nick = document.getElementById("profile-nickname");
        var uid = document.getElementById("profile-uid");
        var ava = document.getElementById("profile-avatar");
        if (p.nickname) nick.innerHTML = "<strong>" + p.nickname + "</strong>";
        if (p.uid) uid.textContent = p.uid;
        if (p.avatar) ava.src = p.avatar;
        const finished = Array.isArray(data.achievements)
          ? data.achievements.length
          : 0;
        const pbCount = Array.isArray(data.achievements)
          ? data.achievements.filter(function (x) {
              return x.pb === true;
            }).length
          : 0;
        document.getElementById("stat-finished").textContent = finished;
        document.getElementById("stat-pb").textContent = pbCount;
      }

      renderEvents();
      renderAchievements();
      renderProfile();
    </script>
  </body>
</html>
